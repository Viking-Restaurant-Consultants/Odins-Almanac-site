<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive P&L Builder - Restaurant Intelligence Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .platform-title { 
            font-size: 2.2rem; 
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .pl-builder {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f1f5f9;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e293b;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .form-input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .currency-input {
            position: relative;
        }
        
        .currency-input::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }
        
        .currency-input input {
            padding-left: 28px;
        }
        
        .percentage-input {
            position: relative;
        }
        
        .percentage-input::after {
            content: '%';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }
        
        .percentage-input input {
            padding-right: 28px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f8fafc;
            color: #475569;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .btn-success {
            background: #22c55e;
            color: white;
        }
        
        .btn-success:hover {
            background: #16a34a;
        }
        
        .results-panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .metric-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .metric-change {
            font-size: 12px;
            font-weight: 500;
        }
        
        .metric-change.positive {
            color: #22c55e;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        .metric-change.neutral {
            color: #64748b;
        }
        
        .performance-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .kpi-card {
            background: #ffffff;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .kpi-score {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .kpi-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            color: #64748b;
        }
        
        .alerts-section {
            margin-top: 30px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        
        .alert.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #dc2626;
        }
        
        .alert.success {
            background: #d1fae5;
            border-left: 4px solid #22c55e;
            color: #065f46;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .pl-builder { padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .results-grid { grid-template-columns: 1fr; }
            .performance-indicators { grid-template-columns: repeat(2, 1fr); }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="platform-title">Comprehensive P&L Builder</h1>
            <p class="subtitle">Professional profit & loss analysis for restaurants</p>
        </div>

        <div class="pl-builder">
            <!-- Restaurant Info -->
            <div class="form-section">
                <h2 class="section-title">Restaurant Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="restaurantName">Restaurant Name</label>
                        <input type="text" id="restaurantName" class="form-input" value="My Restaurant" placeholder="Enter restaurant name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="month">Period Month</label>
                        <select id="month" class="form-input">
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October" selected>October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="year">Period Year</label>
                        <input type="number" id="year" class="form-input" value="2025" min="2020" max="2030">
                    </div>
                </div>
            </div>

            <!-- Tabs for different sections -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('revenue')">Revenue</button>
                <button class="tab" onclick="showTab('cogs')">Cost of Goods</button>
                <button class="tab" onclick="showTab('labor')">Labor Costs</button>
                <button class="tab" onclick="showTab('operating')">Operating Expenses</button>
                <button class="tab" onclick="showTab('targets')">Targets</button>
            </div>

            <!-- Revenue Tab -->
            <div id="revenue-tab" class="tab-content active">
                <div class="form-section">
                    <h3 class="section-title">Revenue - Actual</h3>
                    <div class="form-grid">
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualFoodSales">Food Sales</label>
                            <input type="number" id="actualFoodSales" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualBeverageSales">Beverage Sales</label>
                            <input type="number" id="actualBeverageSales" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualOtherRevenue">Other Revenue</label>
                            <input type="number" id="actualOtherRevenue" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Revenue - Budget</h3>
                    <div class="form-grid">
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetFoodSales">Budget Food Sales</label>
                            <input type="number" id="budgetFoodSales" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetBeverageSales">Budget Beverage Sales</label>
                            <input type="number" id="budgetBeverageSales" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetOtherRevenue">Budget Other Revenue</label>
                            <input type="number" id="budgetOtherRevenue" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>

            <!-- COGS Tab -->
            <div id="cogs-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Cost of Goods Sold - Actual</h3>
                    <div class="form-grid">
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualFoodCost">Food Cost</label>
                            <input type="number" id="actualFoodCost" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualBeverageCost">Beverage Cost</label>
                            <input type="number" id="actualBeverageCost" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Cost of Goods Sold - Budget %</h3>
                    <div class="form-grid">
                        <div class="form-group percentage-input">
                            <label class="form-label" for="budgetFoodCostPct">Budget Food Cost %</label>
                            <input type="number" id="budgetFoodCostPct" class="form-input" value="30" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group percentage-input">
                            <label class="form-label" for="budgetBeverageCostPct">Budget Beverage Cost %</label>
                            <input type="number" id="budgetBeverageCostPct" class="form-input" value="22" step="0.1" min="0" max="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Labor Tab -->
            <div id="labor-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Labor Costs - Actual</h3>
                    <div class="form-grid">
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualKitchenLabor">Kitchen Labor</label>
                            <input type="number" id="actualKitchenLabor" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualFohLabor">Front of House Labor</label>
                            <input type="number" id="actualFohLabor" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualManagementLabor">Management Labor</label>
                            <input type="number" id="actualManagementLabor" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualPayrollTaxes">Payroll Taxes & Benefits</label>
                            <input type="number" id="actualPayrollTaxes" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Labor Costs - Budget %</h3>
                    <div class="form-grid">
                        <div class="form-group percentage-input">
                            <label class="form-label" for="budgetLaborCostPct">Budget Labor Cost %</label>
                            <input type="number" id="budgetLaborCostPct" class="form-input" value="28" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group percentage-input">
                            <label class="form-label" for="budgetPayrollTaxesPct">Budget Payroll Taxes %</label>
                            <input type="number" id="budgetPayrollTaxesPct" class="form-input" value="7" step="0.1" min="0" max="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operating Expenses Tab -->
            <div id="operating-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Operating Expenses - Actual</h3>
                    <div class="form-grid">
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualRent">Rent</label>
                            <input type="number" id="actualRent" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualUtilities">Utilities</label>
                            <input type="number" id="actualUtilities" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualMarketing">Marketing</label>
                            <input type="number" id="actualMarketing" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualRepairsMaintenance">Repairs & Maintenance</label>
                            <input type="number" id="actualRepairsMaintenance" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualSupplies">Supplies</label>
                            <input type="number" id="actualSupplies" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualInsurance">Insurance</label>
                            <input type="number" id="actualInsurance" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualCreditCardFees">Credit Card Fees</label>
                            <input type="number" id="actualCreditCardFees" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="actualOtherExpenses">Other Expenses</label>
                            <input type="number" id="actualOtherExpenses" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Operating Expenses - Budget</h3>
                    <div class="form-grid">
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetRent">Budget Rent</label>
                            <input type="number" id="budgetRent" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetUtilities">Budget Utilities</label>
                            <input type="number" id="budgetUtilities" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetMarketing">Budget Marketing</label>
                            <input type="number" id="budgetMarketing" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetRepairsMaintenance">Budget Repairs & Maintenance</label>
                            <input type="number" id="budgetRepairsMaintenance" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetSupplies">Budget Supplies</label>
                            <input type="number" id="budgetSupplies" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetInsurance">Budget Insurance</label>
                            <input type="number" id="budgetInsurance" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetCreditCardFees">Budget Credit Card Fees</label>
                            <input type="number" id="budgetCreditCardFees" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group currency-input">
                            <label class="form-label" for="budgetOtherExpenses">Budget Other Expenses</label>
                            <input type="number" id="budgetOtherExpenses" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Targets Tab -->
            <div id="targets-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Performance Targets</h3>
                    <div class="form-grid">
                        <div class="form-group percentage-input">
                            <label class="form-label" for="targetFoodCostPct">Target Food Cost %</label>
                            <input type="number" id="targetFoodCostPct" class="form-input" value="30" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group percentage-input">
                            <label class="form-label" for="targetBeverageCostPct">Target Beverage Cost %</label>
                            <input type="number" id="targetBeverageCostPct" class="form-input" value="22" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group percentage-input">
                            <label class="form-label" for="targetLaborCostPct">Target Labor Cost %</label>
                            <input type="number" id="targetLaborCostPct" class="form-input" value="30" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group percentage-input">
                            <label class="form-label" for="targetPrimeCostPct">Target Prime Cost %</label>
                            <input type="number" id="targetPrimeCostPct" class="form-input" value="60" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-group percentage-input">
                            <label class="form-label" for="targetNetProfitPct">Target Net Profit %</label>
                            <input type="number" id="targetNetProfitPct" class="form-input" value="10" step="0.1" min="0" max="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample Data</button>
                <button class="btn btn-primary" onclick="calculatePL()">
                    <span class="spinner" id="calc-spinner" style="display: none;"></span>
                    Calculate P&L
                </button>
                <button class="btn btn-success" onclick="exportToExcel()" id="export-btn" style="display: none;">Export to Excel</button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                Calculating comprehensive P&L analysis...
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel" id="results">
            <h2 class="section-title">P&L Analysis Results</h2>
            
            <!-- Key Metrics Grid -->
            <div class="results-grid" id="metrics-grid">
                <!-- Metrics will be populated by JavaScript -->
            </div>

            <!-- Performance Indicators -->
            <div class="performance-indicators" id="kpi-grid">
                <!-- KPIs will be populated by JavaScript -->
            </div>

            <!-- Alerts Section -->
            <div class="alerts-section" id="alerts">
                <!-- Alerts will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="pl-calculator.js"></script>
    <script>
        let plCalculator = new PLCalculator();
        let lastResults = null;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function loadSampleData() {
            // Populate with realistic sample data
            document.getElementById('restaurantName').value = 'The Golden Spoon';
            document.getElementById('actualFoodSales').value = '85000';
            document.getElementById('actualBeverageSales').value = '25000';
            document.getElementById('actualOtherRevenue').value = '3000';
            
            document.getElementById('budgetFoodSales').value = '80000';
            document.getElementById('budgetBeverageSales').value = '24000';
            document.getElementById('budgetOtherRevenue').value = '2500';
            
            document.getElementById('actualFoodCost').value = '27200';
            document.getElementById('actualBeverageCost').value = '5500';
            
            document.getElementById('actualKitchenLabor').value = '18000';
            document.getElementById('actualFohLabor').value = '14500';
            document.getElementById('actualManagementLabor').value = '8500';
            document.getElementById('actualPayrollTaxes').value = '3200';
            
            document.getElementById('actualRent').value = '12000';
            document.getElementById('actualUtilities').value = '2800';
            document.getElementById('actualMarketing').value = '2200';
            document.getElementById('actualRepairsMaintenance').value = '1500';
            document.getElementById('actualSupplies').value = '1800';
            document.getElementById('actualInsurance').value = '1200';
            document.getElementById('actualCreditCardFees').value = '2800';
            document.getElementById('actualOtherExpenses').value = '2500';
            
            // Budget amounts
            document.getElementById('budgetRent').value = '12000';
            document.getElementById('budgetUtilities').value = '2600';
            document.getElementById('budgetMarketing').value = '2000';
            document.getElementById('budgetRepairsMaintenance').value = '1200';
            document.getElementById('budgetSupplies').value = '1600';
            document.getElementById('budgetInsurance').value = '1200';
            document.getElementById('budgetCreditCardFees').value = '2600';
            document.getElementById('budgetOtherExpenses').value = '2200';
        }

        function gatherFormData() {
            const formData = {};
            const inputs = document.querySelectorAll('input, select');
            
            inputs.forEach(input => {
                formData[input.id] = input.value;
            });
            
            return formData;
        }

        async function calculatePL() {
            const formData = gatherFormData();
            
            // Show loading
            document.getElementById('calc-spinner').style.display = 'inline-block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                // Calculate P&L using our calculator
                const results = plCalculator.calculateComprehensivePL(formData);
                lastResults = results;
                
                // Display results
                displayResults(results);
                
                // Also send to server for persistence and AI analysis
                const response = await fetch('http://localhost:3001/api/pl/comprehensive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        formData: formData,
                        results: results
                    })
                });
                
                if (response.ok) {
                    const serverResponse = await response.json();
                    console.log('P&L saved successfully:', serverResponse);
                }
                
            } catch (error) {
                console.error('Error calculating P&L:', error);
                alert('Error calculating P&L. Please check your inputs and try again.');
            } finally {
                document.getElementById('calc-spinner').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResults(results) {
            // Show results panel
            document.getElementById('results').style.display = 'block';
            
            // Populate metrics grid
            const metricsGrid = document.getElementById('metrics-grid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">${plCalculator.formatCurrency(results.revenue.actualTotal)}</div>
                    <div class="metric-change ${results.revenue.variancePct >= 0 ? 'positive' : 'negative'}">
                        ${results.revenue.variancePct >= 0 ? '+' : ''}${results.revenue.variancePct.toFixed(1)}% vs Budget
                    </div>
                </div>
                
                <div class="metric-card" style="border-left-color: #f59e0b;">
                    <div class="metric-label">Prime Cost</div>
                    <div class="metric-value">${plCalculator.formatCurrency(results.costs.actualPrimeCost)}</div>
                    <div class="metric-change neutral">
                        ${results.costs.actualPrimeCostPct.toFixed(1)}% of Revenue
                    </div>
                </div>
                
                <div class="metric-card" style="border-left-color: ${results.margins.actualNetProfit >= 0 ? '#22c55e' : '#ef4444'};">
                    <div class="metric-label">Net Profit</div>
                    <div class="metric-value">${plCalculator.formatCurrency(results.margins.actualNetProfit)}</div>
                    <div class="metric-change ${results.margins.actualNetProfit >= 0 ? 'positive' : 'negative'}">
                        ${results.margins.actualNetProfitPct.toFixed(1)}% Margin
                    </div>
                </div>
                
                <div class="metric-card" style="border-left-color: #8b5cf6;">
                    <div class="metric-label">Food Cost</div>
                    <div class="metric-value">${plCalculator.formatCurrency(results.costs.actualCOGS)}</div>
                    <div class="metric-change neutral">
                        ${results.costs.actualCOGSPct.toFixed(1)}% of Revenue
                    </div>
                </div>
                
                <div class="metric-card" style="border-left-color: #06b6d4;">
                    <div class="metric-label">Labor Cost</div>
                    <div class="metric-value">${plCalculator.formatCurrency(results.costs.actualLabor)}</div>
                    <div class="metric-change neutral">
                        ${results.costs.actualLaborPct.toFixed(1)}% of Revenue
                    </div>
                </div>
                
                <div class="metric-card" style="border-left-color: #84cc16;">
                    <div class="metric-label">Operating Expenses</div>
                    <div class="metric-value">${plCalculator.formatCurrency(results.costs.actualOpEx)}</div>
                    <div class="metric-change neutral">
                        ${results.costs.actualOpExPct.toFixed(1)}% of Revenue
                    </div>
                </div>
            `;

            // Populate KPI grid
            if (results.analysis && results.analysis.kpis) {
                const kpiGrid = document.getElementById('kpi-grid');
                kpiGrid.innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-score" style="color: ${results.analysis.kpis.revenuePerformance?.color || '#64748b'}">
                            ${results.analysis.kpis.revenuePerformance?.score || 0}
                        </div>
                        <div class="kpi-label">Revenue Performance</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-score" style="color: ${results.analysis.kpis.costControl?.color || '#64748b'}">
                            ${results.analysis.kpis.costControl?.score || 0}
                        </div>
                        <div class="kpi-label">Cost Control</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-score" style="color: ${results.analysis.kpis.laborEfficiency?.color || '#64748b'}">
                            ${results.analysis.kpis.laborEfficiency?.score || 0}
                        </div>
                        <div class="kpi-label">Labor Efficiency</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-score" style="color: ${results.analysis.kpis.profitability?.color || '#64748b'}">
                            ${results.analysis.kpis.profitability?.score || 0}
                        </div>
                        <div class="kpi-label">Profitability</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-score" style="color: ${results.analysis.kpis.overallHealth?.color || '#64748b'}">
                            ${results.analysis.kpis.overallHealth?.score || 0}
                        </div>
                        <div class="kpi-label">Overall Health</div>
                    </div>
                `;
            }

            // Display alerts
            if (results.analysis && results.analysis.alerts) {
                const alertsContainer = document.getElementById('alerts');
                let alertsHTML = '<h3 class="section-title">Performance Alerts</h3>';
                
                if (results.analysis.alerts.length === 0) {
                    alertsHTML += '<div class="alert success">✅ No critical issues detected. Performance is within acceptable ranges.</div>';
                } else {
                    results.analysis.alerts.forEach(alert => {
                        alertsHTML += `
                            <div class="alert ${alert.type}">
                                ${alert.type === 'error' ? '⚠️' : alert.type === 'warning' ? '⚡' : 'ℹ️'} 
                                <strong>${alert.category}:</strong> ${alert.message}
                            </div>
                        `;
                    });
                }
                
                if (results.analysis.recommendations && results.analysis.recommendations.length > 0) {
                    alertsHTML += '<h4 style="margin-top: 20px; margin-bottom: 10px; color: #1e293b;">Recommendations:</h4>';
                    results.analysis.recommendations.forEach(rec => {
                        alertsHTML += `<div class="alert success">💡 ${rec}</div>`;
                    });
                }
                
                alertsContainer.innerHTML = alertsHTML;
            }

            // Show export button
            document.getElementById('export-btn').style.display = 'inline-block';
        }

        async function exportToExcel() {
            if (!lastResults) {
                alert('Please calculate P&L first');
                return;
            }

            try {
                const response = await fetch('http://localhost:3001/api/export/comprehensive-pl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: lastResults,
                        formData: gatherFormData()
                    })
                });

                if (!response.ok) {
                    throw new Error('Export failed');
                }

                // Trigger download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Comprehensive_PL_${lastResults.period.restaurantName}_${lastResults.period.month}_${lastResults.period.year}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set current month
            const currentMonth = new Date().toLocaleString('default', { month: 'long' });
            document.getElementById('month').value = currentMonth;
        });
    </script>
</body>
</html>